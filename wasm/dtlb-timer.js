const PGSIZE = 0x1000;
const TLB_SETS = 0x10;
const CACHE_LINESIZE = 0x40;

const wasmBytes = new Uint8Array([0x00,0x61,0x73,0x6D,0x01,0x00,0x00,0x00,0x01,0x0A,0x02,0x60,0x01,0x7F,0x00,0x60,0x01,0x7F,0x01,0x7F,0x02,0x0D,0x01,0x03,0x65,0x6E,0x76,0x03,0x6D,0x65,0x6D,0x02,0x00,0x80,0x40,0x03,0x03,0x02,0x00,0x00,0x07,0x1E,0x02,0x0A,0x72,0x75,0x6E,0x5F,0x77,0x69,0x74,0x68,0x5F,0x78,0x00,0x00,0x0D,0x72,0x75,0x6E,0x5F,0x77,0x69,0x74,0x68,0x6F,0x75,0x74,0x5F,0x78,0x00,0x01,0x0A,0xC5,0x03,0x02,0xE3,0x01,0x01,0x0A,0x7F,0x41,0x80,0x20,0x21,0x01,0x41,0xC0,0xA0,0x04,0x21,0x02,0x41,0x80,0xA1,0x08,0x21,0x03,0x41,0xC0,0xA1,0x0C,0x21,0x04,0x41,0x80,0xA2,0x10,0x21,0x05,0x41,0xC0,0xA2,0x14,0x21,0x06,0x41,0xC0,0xA2,0x18,0x21,0x07,0x41,0x80,0xA3,0x1C,0x21,0x08,0x41,0xC0,0xA3,0x20,0x21,0x09,0x41,0x00,0x20,0x06,0x6A,0x28,0x02,0x00,0x20,0x07,0x6A,0x28,0x02,0x00,0x20,0x08,0x6A,0x28,0x02,0x00,0x20,0x09,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x02,0x6A,0x28,0x02,0x00,0x20,0x03,0x6A,0x28,0x02,0x00,0x20,0x04,0x6A,0x28,0x02,0x00,0x20,0x05,0x6A,0x28,0x02,0x00,0x20,0x04,0x6A,0x28,0x02,0x00,0x20,0x02,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x03,0x6A,0x28,0x02,0x00,0x03,0x01,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x04,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x02,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x03,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x04,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x02,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x03,0x6A,0x28,0x02,0x00,0x20,0x0A,0x41,0x01,0x6A,0x21,0x0A,0x20,0x0A,0x20,0x00,0x4C,0x0D,0x00,0x0B,0x1A,0x0B,0xDD,0x01,0x01,0x0A,0x7F,0x41,0x80,0x20,0x21,0x01,0x41,0xC0,0xA0,0x04,0x21,0x02,0x41,0x80,0xA1,0x08,0x21,0x03,0x41,0xC0,0xA1,0x0C,0x21,0x04,0x41,0x80,0xA2,0x10,0x21,0x05,0x41,0xC0,0xA2,0x14,0x21,0x06,0x41,0xC0,0xA2,0x18,0x21,0x07,0x41,0x80,0xA3,0x1C,0x21,0x08,0x41,0xC0,0xA3,0x20,0x21,0x09,0x41,0x00,0x20,0x06,0x6A,0x28,0x02,0x00,0x20,0x07,0x6A,0x28,0x02,0x00,0x20,0x08,0x6A,0x28,0x02,0x00,0x20,0x09,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x02,0x6A,0x28,0x02,0x00,0x20,0x03,0x6A,0x28,0x02,0x00,0x20,0x04,0x6A,0x28,0x02,0x00,0x20,0x04,0x6A,0x28,0x02,0x00,0x20,0x02,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x03,0x6A,0x28,0x02,0x00,0x03,0x01,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x04,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x02,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x03,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x04,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x02,0x6A,0x28,0x02,0x00,0x20,0x01,0x6A,0x28,0x02,0x00,0x20,0x03,0x6A,0x28,0x02,0x00,0x20,0x0A,0x41,0x01,0x6A,0x21,0x0A,0x20,0x0A,0x20,0x00,0x4C,0x0D,0x00,0x0B,0x1A,0x0B]);

class DTLBTimer {
    constructor() {
        // WASM pages are 64KB
        // We need 9 identical pages that map to the same dTLB set, so 9 * 16 KiB pages are needed
        // But just allocate a ton of pages 
        this.memory = new WebAssembly.Memory({initial: 8192, maximum: 8192});
        this.wasm = new WebAssembly.Instance(new WebAssembly.Module(wasmBytes), {
            env: {
                mem: this.memory,
            }
        });
    }

    time_without_x(reps) {
        let rv = [];
        for (let i = 0; i < reps; i++) { 
            let t = performance.now();
            this.wasm.exports.run_without_x(0x10000);
            t = performance.now() - t;
            rv.push(t);
        }
        return rv;
    }

    time_with_x(reps) {
        let rv = [];
        for (let i = 0; i < reps; i++) {
            let t = performance.now();
            this.wasm.exports.run_with_x(0x10000);
            t = performance.now() - t;
            rv.push(t);
        }
        return rv;
    }

    warmup() {
        for (let i = 0; i < 0x1000; i++) {
            this.wasm.exports.run_without_x(0x100);
            this.wasm.exports.run_with_x(0x100);
        }
    }
}

function tlb_get_data() {
    let timer = new DTLBTimer();
    timer.warmup();
    let time_without_x = timer.time_without_x(100);
    let time_with_x = timer.time_with_x(100);
    return [time_without_x, time_with_x];
}
